<?xml version="1.0" encoding="utf-8"?>
<robot name="piper" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Prefixed copy of piper_description/urdf/piper_description.xacro. -->

  <xacro:macro name="transmission_block" params="tran_name joint_name motor_name">
    <transmission name="${tran_name}">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="${joint_name}">
            <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
        </joint>
        <actuator name="$motor_name">
            <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
        </actuator>
    </transmission>
  </xacro:macro>

  <xacro:macro name="piper_with_gripper" params="prefix:='piper_' camera_xyz:='0 0 0.05' camera_roll:='0' camera_pitch:='0' camera_yaw:='0'">

  <!-- world -->
    <link name="${prefix}world"/>
    <joint name="${prefix}fixed_base_joint" type="fixed">
        <parent link="${prefix}world"/>
        <child link="${prefix}base_link"/>
    </joint>
  <!-- arm -->
  <link
      name="${prefix}base_link">
      <inertial>
              <origin xyz="-0.00473641164191482 2.56829134630247E-05 0.041451518036016" rpy="0 0 0" />
              <mass value="1.02" />
              <inertia ixx="0.00267433" ixy="-0.00000073" ixz="-0.00017389" iyy="0.00282612" iyz="0.0000004" izz="0.00089624" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/base_link.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/base_link.STL" />
        </geometry>
      </collision>
    </link>
    <link
      name="${prefix}link1">
      <inertial>
        <origin xyz="0.00032 -0.00041 -0.00348" rpy="0 0 0" />
        <mass value="0.71" />
        <inertia ixx="0.00050027" ixy="0.00000078" ixz="0.00000626" iyy="0.00040879" iyz="0.00000462" izz="0.00045802" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link1.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link1.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint1"
      type="revolute">
      <origin
        xyz="0 0 0.123"
        rpy="0 0 0" />
      <parent
        link="${prefix}base_link" />
      <child
        link="${prefix}link1" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="-2.618"
        upper="2.618"
        effort="100"
        velocity="5" />
    </joint>
    <link
      name="${prefix}link2">
      <inertial>
        <origin xyz="0.21852 -0.00861 0.00126" rpy="0 0 0" />
        <mass value="1.16" />
        <inertia ixx="0.00111915" ixy="0.00182916" ixz="0.00019233" iyy="0.06763251" iyz="0.00000767" izz="0.067559" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link2.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link2.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint2"
      type="revolute">
      <origin
        xyz="0 0 0"
        rpy="1.5708 -0.1359 -3.1416" />
        <!-- rpy="1.5708 -0.10095-0.03490659 -3.1416" /> -->
      <parent
        link="${prefix}link1" />
      <child
        link="${prefix}link2" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="0"
        upper="3.14"
        effort="100"
        velocity="5" />
    </joint>
    <link
      name="${prefix}link3">
      <inertial>
        <origin xyz="-0.01999 -0.14808 -0.00053" rpy="0 0 0" />
        <mass value="0.5" />
        <inertia ixx="0.01347608" ixy="0.00161034" ixz="0.00000066" iyy="0.00046377" iyz="0.00000162" izz="0.01363321" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link3.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link3.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint3"
      type="revolute">
      <origin
        xyz="0.28503 0 0"
        rpy="0 0 -1.7939" />
        <!-- rpy="0 0 -1.759-0.03490659" /> -->
      <parent
        link="${prefix}link2" />
      <child
        link="${prefix}link3" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="-2.967"
        upper="0"
        effort="100"
        velocity="5" />
    </joint>
    <link
      name="${prefix}link4">
      <inertial>
        <origin xyz="0.00013 -0.00076 -0.00394" rpy="0 0 0" />
        <mass value="0.38" />
        <inertia ixx="0.00017844" ixy="0.00000062" ixz="0.00000067" iyy="0.00018914" iyz="0.00000408" izz="0.00014613" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link4.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link4.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint4"
      type="revolute">
      <origin
        xyz="-0.021984 -0.25075 0"
        rpy="1.5708 0 0" />
      <parent
        link="${prefix}link3" />
      <child
        link="${prefix}link4" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="-1.745"
        upper="1.745"
        effort="100"
        velocity="5" />
    </joint>
    <link
      name="${prefix}link5">
      <inertial>
        <origin xyz="0.00018 -0.06104 -0.00227" rpy="0 0 0" />
        <mass value="0.383" />
        <inertia ixx="0.00172318" ixy="0.00000259" ixz="0.00000010" iyy="0.00017936" iyz="0.00000990" izz="0.00171172" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link5.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link5.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint5"
      type="revolute">
      <origin
        xyz="0 0 0"
        rpy="-1.5708 0 0" />
      <parent
        link="${prefix}link4" />
      <child
        link="${prefix}link5" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="-1.22"
        upper="1.22"
        effort="100"
        velocity="5" />
    </joint>
    <link
      name="${prefix}link6">
      <inertial>
        <origin xyz="-0.00003 0.00006 0.04618" rpy="0 0 0" />
        <mass value="0.007" />
        <inertia ixx="0.00152112" ixy="0.00000202" ixz="0.00000261" iyy="0.00138626" iyz="0.00000002" izz="0.00031152" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link6.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.898039215686275 0.917647058823529 0.929411764705882 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link6.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint6"
      type="revolute">
      <origin
        xyz="8.8259E-05 -0.091 0"
        rpy="1.5708 0 0" />
      <parent
        link="${prefix}link5" />
      <child
        link="${prefix}link6" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="-2.0944"
        upper="2.0944"
        effort="100"
        velocity="3" />
    </joint>
    <link
      name="${prefix}gripper_base">
      <inertial>
        <origin
          xyz="-0.000183807162235591 8.05033155577911E-05 0.0321436689908876"
          rpy="0 0 0" />
        <mass
          value="0.45" />
        <inertia
          ixx="0.00092934"
          ixy="0.00000034"
          ixz="-0.00000738"
          iyy="0.00071447"
          iyz="0.00000005"
          izz="0.00039442" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/gripper_base.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/gripper_base.STL" />
        </geometry>
      </collision>
    </link> 
    <joint
      name="${prefix}joint6_to_gripper_base"
      type="fixed">
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <parent
        link="${prefix}link6" />
      <child
        link="${prefix}gripper_base" />
    </joint>
    <!-- PiPER wrist camera (RealSense D405) -->
    <link name="${prefix}camera_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <mass value="0.07" />
        <inertia ixx="0.00001867" ixy="0.0" ixz="0.0"
                 iyy="0.00001298" iyz="0.0"
                 izz="0.00001298" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.025 0.04 0.04"/>
        </geometry>
        <material name="silver">
          <color rgba="0.8 0.8 0.8 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.025 0.04 0.04"/>
        </geometry>
      </collision>
    </link>
    <joint name="${prefix}camera_mount_joint" type="fixed">
      <parent link="${prefix}gripper_base"/>
      <child link="${prefix}camera_link"/>
      <origin xyz="${camera_xyz}" rpy="${camera_roll} ${camera_pitch - 1.5708} ${camera_yaw}"/>
    </joint>
    <!-- PiPER wrist camera optical frame -->
    <link name="${prefix}camera_optical_frame"/>
    <joint name="${prefix}camera_optical_joint" type="fixed">
      <parent link="${prefix}camera_link"/>
      <child link="${prefix}camera_optical_frame"/>
      <origin xyz="0 0 0" rpy="${-M_PI/2} 0 ${-M_PI/2}"/>
    </joint>
    <link
      name="${prefix}link7">
      <inertial>
        <origin
          xyz="0.00065123185041968 -0.0491929869131989 0.00972258769184025"
          rpy="0 0 0" />
        <mass
          value="0.025" />
        <inertia
          ixx="0.00007371"
          ixy="-0.00000113"
          ixz="0.00000021"
          iyy="0.00000781"
          iyz="-0.00001372"
          izz="0.0000747" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link7.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link7.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint7"
      type="prismatic">
      <origin
        xyz="0 0 0.1358"
        rpy="1.5708 0 0" />
      <parent
        link="${prefix}gripper_base" />
      <child
        link="${prefix}link7" />
      <axis
        xyz="0 0 1" />
      <limit
        lower="0"
        upper="0.035"
        effort="10"
        velocity="1" />
    </joint>
    <link
      name="${prefix}link8">
      <inertial>
        <origin
          xyz="0.000651231850419722 -0.0491929869131991 0.00972258769184024"
          rpy="0 0 0" />
        <mass
          value="0.025" />
        <inertia
          ixx="0.00007371"
          ixy="-0.00000113"
          ixz="0.00000021"
          iyy="0.00000781"
          iyz="-0.00001372"
          izz="0.0000747" />
      </inertial>
      <visual>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link8.STL" />
        </geometry>
        <material
          name="">
          <color
            rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
        </material>
      </visual>
      <collision>
        <origin
          xyz="0 0 0"
          rpy="0 0 0" />
        <geometry>
          <mesh
            filename="package://piper_description/meshes/link8.STL" />
        </geometry>
      </collision>
    </link>
    <joint
      name="${prefix}joint8"
      type="prismatic">
      <origin
        xyz="0 0 0.1358"
        rpy="1.5708 0 -3.1416" />
      <parent
        link="${prefix}gripper_base" />
      <child
        link="${prefix}link8" />
      <axis
        xyz="0 0 -1" />
      <limit
        lower="-0.035"
        upper="0"
        effort="10"
        velocity="1" />
    </joint>

  <!-- controller -->
    <xacro:transmission_block tran_name="${prefix}tran1" joint_name="${prefix}joint1" motor_name="${prefix}motor1"/>
    <xacro:transmission_block tran_name="${prefix}tran2" joint_name="${prefix}joint2" motor_name="${prefix}motor2"/>
    <xacro:transmission_block tran_name="${prefix}tran3" joint_name="${prefix}joint3" motor_name="${prefix}motor3"/>
    <xacro:transmission_block tran_name="${prefix}tran4" joint_name="${prefix}joint4" motor_name="${prefix}motor4"/>
    <xacro:transmission_block tran_name="${prefix}tran5" joint_name="${prefix}joint5" motor_name="${prefix}motor5"/>
    <xacro:transmission_block tran_name="${prefix}tran6" joint_name="${prefix}joint6" motor_name="${prefix}motor6"/>
    <xacro:transmission_block tran_name="${prefix}tran7" joint_name="${prefix}joint7" motor_name="${prefix}motor7"/>
    <xacro:transmission_block tran_name="${prefix}tran8" joint_name="${prefix}joint8" motor_name="${prefix}motor8"/>
  <!-- gazebo -->
    <gazebo>
      <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
          <robotNamespace>/piper</robotNamespace>
          <parameters> $(find piper_gazebo)/config/ros2_controllers.yaml </parameters>
          <legacyModeNS>true</legacyModeNS>
      </plugin>
    </gazebo>
 
    <!-- <gazebo reference="${prefix}base_link">
      <material>Gazebo/Black</material>
    </gazebo>

    <gazebo reference="${prefix}link1">
      <material>Gazebo/White</material>
    </gazebo>
 
    <gazebo reference="${prefix}link2">
      <material>Gazebo/White</material>
    </gazebo>

    <gazebo reference="${prefix}link3">
      <material>Gazebo/White</material>
    </gazebo>
 
    <gazebo reference="${prefix}link4">
      <material>Gazebo/Black</material>
    </gazebo>
 
    <gazebo reference="${prefix}link5">
      <material>Gazebo/White</material>
    </gazebo>
 
    <gazebo reference="${prefix}link6">
      <material>Gazebo/White</material>
    </gazebo>
 
    <gazebo reference="${prefix}link7">
      <material>Gazebo/Orange</material>
    </gazebo>
 
    <gazebo reference="${prefix}link8">
      <material>Gazebo/Orange</material>
    </gazebo> -->

  </xacro:macro>

</robot>
